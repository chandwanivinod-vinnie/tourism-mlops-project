
name: Tourism MLOps Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: tourism-mlops-main
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.10"

jobs:
  register-dataset:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - name: Install dependencies
        run: pip install -r project/requirements-ci.txt
      - name: Register raw dataset in HF
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
        run: python project/src/register_data.py

  preprocess:
    needs: register-dataset
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - name: Install dependencies
        run: pip install -r project/requirements-ci.txt
      - name: Preprocess and upload train/test splits
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
        run: python project/src/preprocess.py

  train-evaluate-register-model:
    needs: preprocess
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - name: Install dependencies
        run: pip install -r project/requirements-ci.txt
      - name: Train and register model
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
          HF_MODEL_REPO: ${{ secrets.HF_MODEL_REPO }}
        run: python project/src/train.py
      - name: Evaluate model outputs
        run: python project/src/evaluate.py
      - name: Upload experiment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: experiment-artifacts
          path: |
            project/experiments/*.json
            project/models/inference_schema.json
          if-no-files-found: warn

  deploy-space:
    needs: train-evaluate-register-model
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - name: Install dependencies
        run: pip install -r project/requirements-ci.txt
      - name: Push deployment files to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_REPO: ${{ secrets.HF_SPACE_REPO }}
        run: python project/deployment/push_to_hf_space.py

